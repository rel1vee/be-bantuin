generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                       String                    @id @default(cuid())
  email                    String                    @unique
  password                 String?
  fullName                 String                    @map("full_name")
  nim                      String?                   @unique @map("nim")
  major                    String?
  batch                    String?
  phoneNumber              String?                   @map("phone_number")
  profilePicture           String?                   @map("profile_picture")
  bio                      String?
  googleId                 String?                   @unique @map("google_id")
  provider                 String                    @default("email")
  isVerified               Boolean                   @default(false) @map("is_verified")
  emailVerifiedAt          DateTime?                 @map("email_verified_at")
  isSeller                 Boolean                   @default(false) @map("is_seller")
  avgRating                Decimal                   @default(0) @map("avg_rating") @db.Decimal(3, 2)
  totalReviews             Int                       @default(0) @map("total_reviews")
  totalOrdersCompleted     Int                       @default(0) @map("total_orders_completed")
  status                   String                    @default("active")
  role                     Role                      @default(USER)
  createdAt                DateTime                  @default(now()) @map("created_at")
  updatedAt                DateTime                  @updatedAt @map("updated_at")
  cover_picture            String?
  social_media             Json?
  UserActivityLog          UserActivityLog[]
  conversationParticipants ConversationParticipant[]
  disputeMessages          DisputeMessage[]
  openedDisputes           Dispute[]                 @relation("OpenedDisputes")
  resolvedDisputes         Dispute[]                 @relation("ResolvedDisputes")
  messagesSent             Message[]
  notifications            Notification[]
  ordersAsBuyer            Order[]                   @relation("BuyerOrders")
  payoutAccounts           PayoutAccount[]
  payoutRequests           PayoutRequest[]
  push_subscriptions       push_subscriptions[]
  reportsReceived          Report[]                  @relation("ReportsReceived")
  reportsCreated           Report[]                  @relation("ReportsCreated")
  reviews                  Review[]                  @relation("ReviewAuthor")
  services                 Service[]                 @relation("SellerServices")
  wallet                   Wallet?

  @@map("users")
}

model Service {
  id              String        @id @default(cuid())
  sellerId        String        @map("seller_id")
  title           String
  description     String
  category        String
  price           Decimal       @db.Decimal(10, 2)
  deliveryTime    Int           @map("delivery_time")
  revisions       Int           @default(1)
  images          String[]
  totalOrders     Int           @default(0) @map("total_orders")
  avgRating       Decimal       @default(0) @map("avg_rating") @db.Decimal(3, 2)
  totalReviews    Int           @default(0) @map("total_reviews")
  status          ServiceStatus @default(ACTIVE)
  isActive        Boolean       @default(true) @map("is_active")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  additional_info String?
  faq             Json?         @default("[]")
  minimum_order   Int?
  price_per_unit  Decimal?      @db.Decimal(10, 2)
  pricing_type    String?
  requirements    String?
  whats_included  String?
  adminNotes      String?       @map("admin_notes")
  orders          Order[]
  reviews         Review[]
  seller          User          @relation("SellerServices", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([category])
  @@index([status])
  @@map("services")
}

model Order {
  id                 String              @id @default(cuid())
  serviceId          String              @map("service_id")
  buyerId            String              @map("buyer_id")
  title              String
  price              Decimal             @db.Decimal(10, 2)
  deliveryTime       Int                 @map("delivery_time")
  requirements       String
  attachments        String[]
  deliveryFiles      String[]            @map("delivery_files")
  deliveryNote       String?             @map("delivery_note")
  deliveredAt        DateTime?           @map("delivered_at")
  status             OrderStatus         @default(DRAFT)
  isPaid             Boolean             @default(false) @map("is_paid")
  paidAt             DateTime?           @map("paid_at")
  revisionCount      Int                 @default(0) @map("revision_count")
  maxRevisions       Int                 @map("max_revisions")
  revisionNotes      String[]            @default([])
  dueDate            DateTime            @map("due_date")
  completedAt        DateTime?           @map("completed_at")
  cancelledAt        DateTime?           @map("cancelled_at")
  cancellationReason String?             @map("cancellation_reason")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  dispute            Dispute?
  progressLogs       OrderProgress[]
  buyer              User                @relation("BuyerOrders", fields: [buyerId], references: [id])
  service            Service             @relation(fields: [serviceId], references: [id])
  payment            Payment?
  review             Review?
  transactions       WalletTransaction[]

  @@index([serviceId])
  @@index([buyerId])
  @@index([status])
  @@map("orders")
}

model OrderProgress {
  id          String   @id @default(cuid())
  orderId     String   @map("order_id")
  title       String
  description String?
  images      String[]
  createdAt   DateTime @default(now()) @map("created_at")
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_progress_logs")
}

model Review {
  id             String    @id @default(cuid())
  orderId        String    @unique @map("order_id")
  serviceId      String    @map("service_id")
  authorId       String    @map("author_id")
  rating         Int
  comment        String
  sellerResponse String?   @map("seller_response")
  respondedAt    DateTime? @map("responded_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  author         User      @relation("ReviewAuthor", fields: [authorId], references: [id])
  order          Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  service        Service   @relation(fields: [serviceId], references: [id])

  @@index([serviceId])
  @@index([authorId])
  @@map("reviews")
}

model Wallet {
  id             String              @id @default(cuid())
  userId         String              @unique @map("user_id")
  balance        Decimal             @default(0) @db.Decimal(12, 2)
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  payoutRequests PayoutRequest[]
  transactions   WalletTransaction[]
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model WalletTransaction {
  id              String                @id @default(cuid())
  walletId        String                @map("wallet_id")
  orderId         String?               @map("order_id")
  paymentId       String?               @map("payment_id")
  type            WalletTransactionType
  amount          Decimal               @db.Decimal(12, 2)
  balanceBefore   Decimal               @map("balance_before") @db.Decimal(12, 2)
  balanceAfter    Decimal               @map("balance_after") @db.Decimal(12, 2)
  description     String
  createdAt       DateTime              @default(now()) @map("created_at")
  payoutRequestId String?               @map("payout_request_id")
  disputeId       String?               @map("dispute_id")
  dispute         Dispute?              @relation(fields: [disputeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  order           Order?                @relation(fields: [orderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payment         Payment?              @relation(fields: [paymentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payoutRequest   PayoutRequest?        @relation(fields: [payoutRequestId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  wallet          Wallet                @relation(fields: [walletId], references: [id])

  @@index([walletId])
  @@index([orderId])
  @@index([type])
  @@map("wallet_transactions")
}

model Payment {
  id                 String              @id @default(cuid())
  orderId            String              @unique @map("order_id")
  amount             Decimal             @db.Decimal(12, 2)
  status             PaymentStatus       @default(PENDING)
  gateway            String              @default("midtrans")
  gatewayToken       String?             @map("gateway_token")
  gatewayRedirectUrl String?             @map("gateway_redirect_url")
  paymentType        String?             @map("payment_type")
  transactionId      String?             @unique @map("transaction_id")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  order              Order               @relation(fields: [orderId], references: [id])
  transactions       WalletTransaction[]

  @@index([orderId])
  @@index([status])
  @@index([transactionId])
  @@map("payments")
}

model PayoutAccount {
  id            String          @id @default(cuid())
  userId        String          @map("user_id")
  bankName      String          @map("bank_name")
  accountName   String          @map("account_name")
  accountNumber String          @map("account_number")
  isPrimary     Boolean         @default(false) @map("is_primary")
  createdAt     DateTime        @default(now()) @map("created_at")
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  payouts       PayoutRequest[]

  @@unique([userId, accountNumber])
  @@index([userId])
  @@map("payout_accounts")
}

model PayoutRequest {
  id                 String              @id @default(cuid())
  userId             String              @map("user_id")
  walletId           String              @map("wallet_id")
  accountId          String              @map("account_id")
  amount             Decimal             @db.Decimal(12, 2)
  status             PayoutStatus        @default(PENDING)
  requestedAt        DateTime            @default(now()) @map("requested_at")
  processedAt        DateTime?           @map("processed_at")
  adminNotes         String?             @map("admin_notes")
  account            PayoutAccount       @relation(fields: [accountId], references: [id])
  user               User                @relation(fields: [userId], references: [id])
  wallet             Wallet              @relation(fields: [walletId], references: [id])
  walletTransactions WalletTransaction[]

  @@index([userId])
  @@index([walletId])
  @@index([status])
  @@map("payout_requests")
}

model Dispute {
  id                 String              @id @default(cuid())
  orderId            String              @unique @map("order_id")
  openedById         String              @map("opened_by_id")
  status             DisputeStatus       @default(OPEN)
  reason             String
  resolution         DisputeResolution?
  resolvedById       String?             @map("resolved_by_id")
  resolvedAt         DateTime?           @map("resolved_at")
  adminNotes         String?             @map("admin_notes")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  messages           DisputeMessage[]
  openedBy           User                @relation("OpenedDisputes", fields: [openedById], references: [id])
  order              Order               @relation(fields: [orderId], references: [id])
  resolvedBy         User?               @relation("ResolvedDisputes", fields: [resolvedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  walletTransactions WalletTransaction[]

  @@index([orderId])
  @@index([openedById])
  @@index([resolvedById])
  @@index([status])
  @@map("disputes")
}

model DisputeMessage {
  id          String   @id @default(cuid())
  disputeId   String   @map("dispute_id")
  senderId    String   @map("sender_id")
  content     String
  attachments String[]
  createdAt   DateTime @default(now()) @map("created_at")
  dispute     Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  sender      User     @relation(fields: [senderId], references: [id])

  @@index([disputeId])
  @@index([senderId])
  @@map("dispute_messages")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  content   String
  isRead    Boolean  @default(false) @map("is_read")
  link      String?
  type      String?  @default("GENERAL")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model Conversation {
  id            String                    @id @default(cuid())
  createdAt     DateTime                  @default(now()) @map("created_at")
  updatedAt     DateTime                  @updatedAt @map("updated_at")
  lastMessageId String?                   @unique @map("last_message_id")
  participants  ConversationParticipant[]
  lastMessage   Message?                  @relation("LastMessage", fields: [lastMessageId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  messages      Message[]

  @@index([updatedAt])
  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  userId         String       @map("user_id")
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

model Message {
  id                        String        @id @default(cuid())
  conversationId            String        @map("conversation_id")
  senderId                  String        @map("sender_id")
  content                   String
  isRead                    Boolean       @default(false) @map("is_read")
  readAt                    DateTime?     @map("read_at")
  createdAt                 DateTime      @default(now()) @map("created_at")
  lastMessageInConversation Conversation? @relation("LastMessage")
  conversation              Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender                    User          @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

model Report {
  id             String       @id @default(cuid())
  reporterId     String       @map("reporter_id")
  reportedUserId String       @map("reported_user_id")
  reason         String
  description    String
  evidence       String[]
  status         ReportStatus @default(OPEN)
  adminNotes     String?      @map("admin_notes")
  resolvedAt     DateTime?    @map("resolved_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  reportedUser   User         @relation("ReportsReceived", fields: [reportedUserId], references: [id])
  reporter       User         @relation("ReportsCreated", fields: [reporterId], references: [id])

  @@index([reporterId])
  @@index([reportedUserId])
  @@map("reports")
}

model SecurityLog {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  level     String
  ip        String
  method    String
  url       String
  userAgent String?
  payload   Json?
  message   String
  userId    String?
}

model UserActivityLog {
  id        Int      @id @default(autoincrement())
  userId    String
  timestamp DateTime @default(now())
  action    String
  ip        String?
  device    String?
  status    String
  details   String?
  users     User     @relation(fields: [userId], references: [id])
}

model push_subscriptions {
  id         String   @id
  user_id    String
  endpoint   String
  keys       Json
  created_at DateTime @default(now())
  users      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

enum Role {
  USER
  ADMIN
}

enum ServiceStatus {
  ACTIVE
  PAUSED
  DELETED
  PENDING
  REJECTED
}

enum OrderStatus {
  DRAFT
  WAITING_PAYMENT
  PAID_ESCROW
  IN_PROGRESS
  DELIVERED
  REVISION
  COMPLETED
  CANCELLED
  DISPUTED
  RESOLVED
}

enum PaymentStatus {
  PENDING
  SETTLEMENT
  EXPIRE
  CANCELLED
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum WalletTransactionType {
  ESCROW_RELEASE
  ESCROW_REFUND
  PAYOUT_REQUEST
  PAYOUT_REJECTED
  DISPUTE_RELEASE
  DISPUTE_REFUND
}

enum DisputeStatus {
  OPEN
  RESOLVED
}

enum DisputeResolution {
  RELEASE_TO_SELLER
  REFUND_TO_BUYER
}

enum ReportStatus {
  OPEN
  RESOLVED
  DISMISSED
}
